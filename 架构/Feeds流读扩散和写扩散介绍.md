# Feeds流读扩散和写扩散介绍

> 本文介绍消息流系统中常见的消息扩散方式。

在设计基于用户关系型 `feeds` 流（例如“关注”）的实现方案时，我们首先要解决的就是选型消息的扩散方式，常见的扩散方式如下表所示：

| 扩散方式 | 优点 | 缺点 | 缺点 | 适用的场景 | 采用的产品 |
|-|-|-|-|-|-|
| 读扩散 | `pull` 方式，每读一次 `feeds` 流都会扩散为 `N` 次（`N`为关注人数）读操作以及一次聚合操作 | 节约存储，写操作逻辑简单 | 读操作逻辑复杂 | 用户不活跃、关注人数少；大V粉丝量巨大 | Facebook，QQ空间 |
| 写扩散 | `push` 方式，每发一条内容都会扩散为 `M` 次（`M`为粉丝数）写操作 | 读操作逻辑简单 | 写操作逻辑复杂，浪费存储 | 用户活跃、关注人数多；大V少，用户粉丝量普遍较少 | 微信朋友圈，Twitter |
| 读写结合 | `pull+push`方式，根据粉丝数决定采用读扩散还是写扩散，或二者结合 | 结合了读扩散和写扩散的优点 | 方案设计较复杂 | 根据粉丝量采用不同策略 | 新浪微博 |

读扩散的好处是节省存储空间，发布者只需要将消息存储到自己的发件箱即可。但缺点是阅读者如果关注的人数非常多，每次拉取最新的 `feeds` 流时，要遍历一遍所有的关注人的发件箱，然后再将内容聚合，开销和时延开销可能会很大。

写扩散的好处是每次发布者将消息写到所有粉丝的收件箱里，粉丝上线时只要读自己的收件箱里的内容就行了，使读操作变得很快很轻量。这也是一种用空间（数据多副本存储）换时间的思路。发布者的消息可以利用消息队列慢慢发给所有粉丝。但遇到粉丝量巨大的发布者（比如微博大V，动辄上亿粉丝）采用写扩散就不合适了。而对于微信朋友圈来说，每个微信号的好友是有上限的（`5000`个）且是一个读多写少的场景，就非常适合采用写扩散方式。

而像新浪微博这种应用场景，既有粉丝量巨大的大V，也有大量不活跃的普通用户，因此可以结合写扩散和读扩散的优点，根据粉丝数量来决定采用哪种扩散方式。

目前 `feeds` 流系统发展已经比较成熟，再复杂的业务需求和场景也都是以读扩散、写扩散或读写结合方式为基础，额外加入一些适用于业务的变化。因此加深对于这几种消息扩散方式的理解是非常重要的。
