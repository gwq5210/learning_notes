# C++ 条件变量

## 条件变量（condition variable）

在 `C` 语言中我们使用 `pthread_cond_wait` 函数作为条件变量，它是由操作系统实现的条件变量，需要详细了解它的运行机制就可以了解 `C++` 中条件变量的实现。在 `C++ 11` 以后，我们可以使用条件变量（condition_variable）实现多个线程间的同步操作；当条件不满足时，相关线程被一直阻塞，直到某种条件出现，这些线程才会被唤醒。`C++` 中包含的头文件在 `#include <condition_variable>` 中。

条件变量是利用线程间共享的全局变量进行同步的一种机制，主要包括两个动作

- 一个线程因等待条件变量的条件成立而挂起；
- 另外一个线程使条件成立从而给出唤醒线程的信号，从而唤醒被等待的线程；

为了防止竞争，条件变量的使用总是和一个互斥锁结合在一起；通常情况下这个锁是 `std::mutex`，并且管理这个锁只能是 `std::unique_lock<std::mutex>` 等 RAII 模板类。

分别是使用以下两个方法实现：

- 等待条件成立使用的是 `condition_variable` 类成员 `wait`、`wait_for` 或 `wait_until`。
- 唤醒信号使用的是 `condition_variable` 类成员 `notify_one` 或者 `notify_all` 函数。

condition_variable 支持的函数如下:

- 构造函数: 它只有默认构造函数，拷贝构造函数和赋值符号重载均被禁止 `condition_variable(const condition_variable&) = delete;`，`condition_variable& operator=(const condition_variable&) delete`；
- `wait`：`wait` 目前支持 `wait`，`wait_for`，`wait_until` 等三种操作

### wait

`wait`对应的函数原型为:

```cpp
void wait( std::unique_lock<std::mutex>& lock );
```

当前线程执行时就被阻塞，直到等到被 `notify` 唤醒。在阻塞线程的那一刻，该函数自动调用 `lck.unlock()`，允许其他被 `lck` 锁定的线程继续运行。阻塞时被一旦某个线程 `notify` 时，实际可能为虚假唤醒，该函数将解除阻塞并调用 `lck.lock()`，获取互斥锁。

`wait`另一个重载如下

```cpp
template <class Predicate>
void wait (unique_lock<mutex>& lck, Predicate pred);
```

调用时检查 `pred`，如果为 `false`, 则阻塞线程，并且调用 `lock.unlock()`, 否则，继续执行。阻塞时被一旦某个线程 `notify` 时，实际可能为虚假唤醒，该函数将再次检查 `pred`，如果为 `true`，则解除阻塞并调用 `lck.lock()`，获取互斥锁；否则继续阻塞线程。

### wait_for

`wait_for`对应的函数原型为:

```cpp
template< class Rep, class Period >
std::cv_status wait_for( std::unique_lock<std::mutex>& lock,
                         const std::chrono::duration<Rep, Period>& rel_time);

template< class Rep, class Period, class Predicate >
bool wait_for( std::unique_lock<std::mutex>& lock,
               const std::chrono::duration<Rep, Period>& rel_time,
               Predicate pred);
// 等价于 wait_until(lock, std::chrono::steady_clock::now() + rel_time, std::move(stop_waiting));
// This overload may be used to ignore spurious awakenings(虚假唤醒) by looping until some predicate is satisfied (bool(stop_waiting()) == true).
```

## 参考资料

- []()
